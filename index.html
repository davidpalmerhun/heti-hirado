<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <title>Heti Híradó</title>

  <!--  ===== Firebase “compat” CDN-ek  =====  -->
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-storage.js"></script>

  <style>
    body{font-family:"Segoe UI",Roboto,Arial,sans-serif;background:#f5f5f5;margin:0;padding:24px;display:flex;justify-content:center}
    .wrapper{max-width:1000px;width:100%}
    h1{text-align:center;margin:0 0 24px}
    .project{background:#fff;border:1px solid #ccc;border-radius:6px;padding:20px;margin-bottom:24px;position:relative}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
    .controls-row{display:flex;gap:10px;align-items:center;margin-top:6px;width:100%}
    input[type=text],textarea,select{padding:6px;border:1px solid #ccc;border-radius:4px;font-size:14px}
    textarea{width:100%;resize:vertical;min-height:60px}
    .link-input{flex:1 1 300px}
    .three-input-row input[type=text]{font-weight:bold;font-size:16px;flex:1 1 200px}
    .button{background:#F4B731;color:#fff;border:none;border-radius:4px;padding:6px 12px;cursor:pointer}
    .button:hover{background:#e0a520}
    .note{margin-left:20px;margin-bottom:14px;position:relative}
    .comment-thread{margin-left:40px;margin-top:14px;position:relative}
    .uploaded-files{display:inline-flex;gap:8px;align-items:center}
    .uploaded-files button{background:none;border:none;color:red;cursor:pointer;font-size:16px;padding:0 2px}
    .delete-btn{position:absolute;top:6px;right:6px;background:none;border:none;color:#B72E2E;font-size:19px;cursor:pointer;border-radius:50%;width:26px;height:26px;display:flex;align-items:center;justify-content:center}
    .delete-btn:hover{background:#ffe3e3}
  </style>
</head>
<body>
  <div class="wrapper">
    <h1>Heti Híradó</h1>
    <div id="container"></div>
    <button class="button" onclick="addProject()">+ Projekt hozzáadása</button>
  </div>

  <script>
    /* ---------- Firebase init ---------- */
    const firebaseConfig = {
      apiKey:            "AIzaSyDn12dx4VO5COB2_eu7OCOusmT4z-NwdDA",
      authDomain:        "heti-hirado.firebaseapp.com",
      projectId:         "heti-hirado",
      storageBucket:     "heti-hirado.appspot.com",   //  fontos: .appspot.com
      messagingSenderId: "672469992573",
      appId:             "1:672469992573:web:3c062fa37a4694c1c89d14",
      measurementId:     "G-HRR8CCEJMT"
    };
    firebase.initializeApp(firebaseConfig);
    const db      = firebase.firestore();
    const storage = firebase.storage();

    /* ---------- Realtime megjelenítés ---------- */
    const projectsCol = db.collection("projects");

    projectsCol.orderBy("created").onSnapshot(snap=>{
      const c = document.getElementById('container');
      c.innerHTML='';
      snap.forEach(d=>c.appendChild(renderProject(d)));
    });

    /* ---------- UI-rajzoló függvények ---------- */
    function renderProject(doc){
      const p = doc.data(), id = doc.id;
      const el = document.createElement('div'); el.className='project';

      el.innerHTML = `
        <div class="row three-input-row">
          <input type="text" value="${p.organizer||''}" placeholder="Szervező neve"
                 onblur="updateField('${id}','organizer',this.value)">
          <input type="text" value="${p.city||''}" placeholder="Város"
                 onblur="updateField('${id}','city',this.value)">
          <input type="text" id="link-${id}" class="link-input" value="${p.link||''}" placeholder="Link (pl. https://...)"
                 onblur="updateField('${id}','link',this.value)">
          <button class="button" onclick="openLink('link-${id}')">Megnyitás</button>
        </div>
        <div id="notes-${id}"></div>
        <button class="button" onclick="addNote('${id}')">+ Vázlatpont</button>
        <button class="delete-btn" onclick="deleteProject('${id}')" title="Projekt törlése">×</button>
      `;

      /* vázlatpontok */
      const notesWrap = el.querySelector(`#notes-${id}`);
      (p.notes||[]).forEach((n,i)=>notesWrap.appendChild(renderNote(id,i,n)));

      return el;
    }

    function renderNote(pid, idx, n){
      const w = document.createElement('div'); w.className='note';
      w.innerHTML = `
        <button class="delete-btn" onclick="deleteNote('${pid}',${idx})" title="Vázlat törlése">×</button>
        <textarea onblur="updateNote('${pid}',${idx},this.value)">${n.text||''}</textarea>
        <div class="controls-row">
          <button class="button" onclick="addComment('${pid}',${idx})">Kommentálom</button>
          <div class="uploaded-files">${renderFiles(pid,idx,n.files)}</div>
          <input type="file" multiple onchange="uploadFiles(this,'${pid}',${idx})">
        </div>
        <div>${renderComments(pid,idx,n.comments)}</div>
      `;
      return w;
    }

    const renderFiles=(pid,idx,arr)=> (arr||[]).map((f,i)=>`
        <span>
          <a href="${f.url}" target="_blank">${f.name}</a>
          <button onclick="removeFile('${pid}',${idx},${i})">✕</button>
        </span>`).join('');

    const renderComments=(pid,idx,arr)=> (arr||[]).map((c,i)=>`
        <div class="comment-thread">
          <button class="delete-btn" onclick="deleteComment('${pid}',${idx},${i})">×</button>
          <b>${c.name}</b>: ${c.text}
        </div>`).join('');

    /* ---------- CRUD műveletek ---------- */
    /* Projekt */
    function addProject(){
      projectsCol.add({organizer:'',city:'',link:'',notes:[],created:firebase.firestore.FieldValue.serverTimestamp()});
    }
    function deleteProject(id){ confirm('Törlöd?')&&projectsCol.doc(id).delete(); }
    function updateField(id,f,v){ projectsCol.doc(id).update({[f]:v}); }

    /* Vázlatpont */
    async function addNote(pid){
      const d = await projectsCol.doc(pid).get(), notes=d.data().notes||[];
      notes.push({text:'',files:[],comments:[]});
      projectsCol.doc(pid).update({notes});
    }
    async function updateNote(pid,idx,val){
      const d=await projectsCol.doc(pid).get(), notes=d.data().notes||[];
      notes[idx].text=val; projectsCol.doc(pid).update({notes});
    }
    async function deleteNote(pid,idx){
      if(!confirm('Törlöd a vázlatot?'))return;
      const d=await projectsCol.doc(pid).get(), notes=d.data().notes||[];
      notes.splice(idx,1); projectsCol.doc(pid).update({notes});
    }

    /* Fájlok */
    async function uploadFiles(inp,pid,idx){
      const d=await projectsCol.doc(pid).get(), notes=d.data().notes||[];
      const list=notes[idx].files||[];
      for(const file of inp.files){
        const ref=storage.ref(`projects/${pid}/${idx}-${file.name}`);
        await ref.put(file); const url=await ref.getDownloadURL();
        list.push({name:file.name,url});
      }
      notes[idx].files=list; projectsCol.doc(pid).update({notes}); inp.value='';
    }
    async function removeFile(pid,idx,i){
      const d=await projectsCol.doc(pid).get(), notes=d.data().notes||[];
      const file=notes[idx].files[i]; if(!file)return;
      await storage.refFromURL(file.url).delete();
      notes[idx].files.splice(i,1); projectsCol.doc(pid).update({notes});
    }

    /* Komment */
    async function addComment(pid,idx){
      const text=prompt('Komment:'); if(!text)return;
      const d=await projectsCol.doc(pid).get(), notes=d.data().notes||[];
      (notes[idx].comments||=[]).push({name:'Ádám',text});
      projectsCol.doc(pid).update({notes});
    }
    async function deleteComment(pid,idx,i){
      const d=await projectsCol.doc(pid).get(), notes=d.data().notes||[];
      notes[idx].comments.splice(i,1); projectsCol.doc(pid).update({notes});
    }

    /* Link megnyitás */
    function openLink(id){
      const u=document.getElementById(id).value.trim();
      if(u) window.open(/^https?:\/\//.test(u)?u:'https://'+u,'_blank');
      else alert('Adj meg egy érvényes URL-t!');
    }
  </script>
</body>
</html>
