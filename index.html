<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <title>Heti Híradó</title>
  <style>
    body {
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
      background-color: #f5f5f5;
      color: #333;
      margin: 0;
      padding: 20px;
      display: flex;
      justify-content: center;
    }
    .wrapper { max-width: 1000px; width: 100%; }
    h1 { text-align: center; color: #222; margin-bottom: 30px; }
    .project-outer {
      position: relative;
      margin-bottom: 40px;
    }
    .project {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 20px;
    }
    .project-tab-delete {
      position: absolute;
      top: -12px;
      right: -12px;
      background: #fff;
      border: 2px solid #F4B731;
      color: #B72E2E;
      font-size: 17px;
      font-weight: bold;
      border-radius: 9px 24px 9px 24px;
      width: 28px;
      height: 28px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      z-index: 10;
      transition: background 0.2s, color 0.2s;
      display: flex; align-items: center; justify-content: center;
      padding: 0;
    }
    .project-tab-delete:hover {
      background: #ffe3e3;
      color: #a00;
      border-color: #e0a520;
    }
    .row { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; align-items: flex-start; }
    .controls-row { display: flex; gap: 10px; align-items: center; margin-top: 5px; width: 100%; }
    .uploaded-files { display: inline-flex; gap: 8px; align-items: center; min-width: 40px; flex-shrink: 0; }
    .controls-row input[type="file"] { margin-left: auto; }
    input[type="text"], textarea, select { padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
    textarea { width: 100%; resize: vertical; min-height: 60px; }
    .link-input { flex-grow: 1; min-width: 300px; }
    .three-input-row input[type="text"] { font-size: 16px; font-weight: bold; flex: 1; min-width: 200px; }
    .button { background-color: #F4B731; border: none; padding: 6px 12px; border-radius: 4px; color: white; cursor: pointer; height: fit-content; }
    .button:hover { background-color: #e0a520; }
    .comment-thread { margin-left: 40px; margin-top: 15px; margin-bottom: 5px; position: relative; }
    .uploaded-files a { margin: 0; }
    .uploaded-files button { background: transparent; border: none; color: red; cursor: pointer; padding: 0 2px; font-size: 16px; line-height: 1; }
    .note { margin-left: 20px; margin-bottom: 15px; clear: both; position: relative; }
    .comment-thread select { margin-bottom: 6px; display: block; }
    .delete-btn { position: absolute; top: 6px; right: 6px; background: transparent; border: none; color: #B72E2E; font-size: 19px; cursor: pointer; padding: 0 4px 2px 4px; border-radius: 50%; transition: background 0.2s; z-index: 3; line-height: 1; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; }
    .delete-btn:hover { background: #ffe3e3; }
    .delete-btn span { font-size: 21px; font-weight: bold; display: block; line-height: 1; margin-top: -2px; }
  </style>
  <!-- Firebase SDK-k -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <div class="wrapper">
    <h1>Heti Híradó</h1>
    <div id="container"></div>
    <button class="button" onclick="addProject()">+ Projekt hozzáadása</button>
  </div>
  <script>
    // Firebase config (a te json.html-edből)
    const firebaseConfig = {
      apiKey: "AIzaSyDn12dx4VO5COB2_eu7OCOusmT4z-NwdDA",
      authDomain: "heti-hirado.firebaseapp.com",
      projectId: "heti-hirado",
      storageBucket: "heti-hirado.appspot.com",
      messagingSenderId: "672469992573",
      appId: "1:672469992573:web:3c062fa37a4694c1c89d14",
      measurementId: "G-HRR8CCEJMT"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    db.collection("projects").orderBy("created", "asc").onSnapshot((querySnapshot) => {
      const container = document.getElementById('container');
      container.innerHTML = '';
      querySnapshot.forEach((doc) => {
        renderProject(doc.id, doc.data());
      });
    });

    function addProject() {
      db.collection("projects").add({
        organizer: "",
        city: "",
        link: "",
        notes: [],
        created: Date.now()
      });
    }

    function renderProject(id, data) {
      const outerDiv = document.createElement('div');
      outerDiv.className = 'project-outer';
      outerDiv.innerHTML = `
        <button class="project-tab-delete" title="Projekt törlése" onclick="deleteProject('${id}')">&times;</button>
        <div class="project">
          <div class="row three-input-row">
            <input type="text" placeholder="Szervező neve" value="${escapeHtml(data.organizer)}" 
              onchange="updateProject('${id}', 'organizer', this.value)">
            <input type="text" placeholder="Város" value="${escapeHtml(data.city)}" 
              onchange="updateProject('${id}', 'city', this.value)">
            <input type="text" class="link-input" id="${id}-link" placeholder="Link (pl. https://...)" value="${escapeHtml(data.link)}"
              onchange="updateProject('${id}', 'link', this.value)">
            <button class="button" onclick="openLink('${id}-link')">Megnyitás Chrome-ban</button>
          </div>
          <div id="${id}-notes"></div>
          <button class="button" onclick="addNote('${id}')">+ Vázlatpont</button>
        </div>
      `;
      document.getElementById('container').appendChild(outerDiv);
      // Jegyzetek (notes) renderelése:
      const notesDiv = outerDiv.querySelector(`#${id}-notes`);
      if (data.notes && data.notes.length > 0) {
        data.notes.forEach((note, idx) => renderNote(notesDiv, id, note, idx));
      }
    }

    function deleteProject(id) {
      if (confirm("Biztosan törlöd ezt a projektet?")) {
        db.collection("projects").doc(id).delete();
      }
    }

    function updateProject(id, field, value) {
      db.collection("projects").doc(id).update({ [field]: value });
    }

    function addNote(projectId) {
      db.collection("projects").doc(projectId).get().then(doc => {
        const data = doc.data();
        const notes = data.notes || [];
        notes.push({ text: "", comments: [] });
        db.collection("projects").doc(projectId).update({ notes: notes });
      });
    }

    function renderNote(notesDiv, projectId, note, noteIdx) {
      const noteDiv = document.createElement('div');
      noteDiv.className = 'note';
      noteDiv.innerHTML = `
        <button class="delete-btn" title="Vázlatpont törlése" onclick="deleteNote('${projectId}', ${noteIdx})"><span>&times;</span></button>
        <textarea placeholder="Vázlatpont" onchange="updateNote('${projectId}', ${noteIdx}, this.value)">${escapeHtml(note.text || "")}</textarea>
        <div class="controls-row">
          <button class="button" onclick="addCommentThread('${projectId}', ${noteIdx})">Kommentálom</button>
        </div>
        <div class="comments-container"></div>
      `;
      notesDiv.appendChild(noteDiv);
      // Kommentek renderelése:
      const commentsDiv = noteDiv.querySelector('.comments-container');
      if (note.comments && note.comments.length > 0) {
        note.comments.forEach((comment, idx) => renderComment(commentsDiv, projectId, noteIdx, comment, idx));
      }
    }

    function updateNote(projectId, noteIdx, value) {
      db.collection("projects").doc(projectId).get().then(doc => {
        const data = doc.data();
        const notes = data.notes || [];
        notes[noteIdx].text = value;
        db.collection("projects").doc(projectId).update({ notes: notes });
      });
    }

    function deleteNote(projectId, noteIdx) {
      db.collection("projects").doc(projectId).get().then(doc => {
        const data = doc.data();
        const notes = data.notes || [];
        notes.splice(noteIdx, 1);
        db.collection("projects").doc(projectId).update({ notes: notes });
      });
    }

    function addCommentThread(projectId, noteIdx) {
      db.collection("projects").doc(projectId).get().then(doc => {
        const data = doc.data();
        const notes = data.notes || [];
        notes[noteIdx].comments = notes[noteIdx].comments || [];
        notes[noteIdx].comments.push({ user: "Ádám", text: "" });
        db.collection("projects").doc(projectId).update({ notes: notes });
      });
    }

    function renderComment(commentsDiv, projectId, noteIdx, comment, commentIdx) {
      const thread = document.createElement('div');
      thread.className = 'comment-thread';
      thread.innerHTML = `
        <button class="delete-btn" title="Komment törlése" onclick="deleteComment('${projectId}', ${noteIdx}, ${commentIdx})"><span>&times;</span></button>
        <select onchange="updateCommentUser('${projectId}', ${noteIdx}, ${commentIdx}, this.value)">
          <option ${comment.user === "Ádám" ? "selected" : ""}>Ádám</option>
          <option ${comment.user === "Dávid" ? "selected" : ""}>Dávid</option>
        </select>
        <textarea placeholder="Válasz komment" style="margin-bottom:5px;" onchange="updateComment('${projectId}', ${noteIdx}, ${commentIdx}, this.value)">${escapeHtml(comment.text || "")}</textarea>
      `;
      commentsDiv.appendChild(thread);
    }

    function updateComment(projectId, noteIdx, commentIdx, value) {
      db.collection("projects").doc(projectId).get().then(doc => {
        const data = doc.data();
        const notes = data.notes || [];
        notes[noteIdx].comments[commentIdx].text = value;
        db.collection("projects").doc(projectId).update({ notes: notes });
      });
    }

    function updateCommentUser(projectId, noteIdx, commentIdx, value) {
      db.collection("projects").doc(projectId).get().then(doc => {
        const data = doc.data();
        const notes = data.notes || [];
        notes[noteIdx].comments[commentIdx].user = value;
        db.collection("projects").doc(projectId).update({ notes: notes });
      });
    }

    function deleteComment(projectId, noteIdx, commentIdx) {
      db.collection("projects").doc(projectId).get().then(doc => {
        const data = doc.data();
        const notes = data.notes || [];
        notes[noteIdx].comments.splice(commentIdx, 1);
        db.collection("projects").doc(projectId).update({ notes: notes });
      });
    }

    function openLink(id) {
      const input = document.getElementById(id);
      const url = input.value.trim();
      if (url) {
        window.open(url.startsWith('http') ? url : 'https://' + url, '_blank');
      } else {
        alert('Adj meg egy érvényes linket!');
      }
    }

    function escapeHtml(unsafe) {
      return unsafe
        ? unsafe.replace(/[&<"']/g, function (m) {
            return (
              { "&": "&amp;", "<": "&lt;", '"': "&quot;", "'": "&#039;" }[m]
            );
          })
        : "";
    }
  </script>
</body>
</html>
